#! /bin/bash
 
echo "Hello, $USER!"
 
echo -e "1 - Install SertCenter\n2 - Customize Sert. Center\n3 - Get server sertif\n4 - Server config-file\n\
5 - Start OpenVPN Server\n6 - Enable ip_forwarding\n7 - Configuring the firewall\n* - Exit"
read -p "Enter a number: " number
case $number in
   1) echo 'pattern 1'
      # exit 1
      # Install Sert. Center
      sudo apt-get update
      ;;
   2) echo 'pattern 2'
      # exit 1
      # Customize Sert. Center
      sudo apt-get install openvpn easy-rsa
      sudo mkdir /etc/openvpn/easy-rsa
      sudo cp -R /usr/share/easy-rsa /etc/openvpn/
 
      cd /etc/openvpn/easy-rsa/
 
      sudo ./easyrsa build-ca
      sudo ./easyrsa gen-dh
      sudo openvpn --genkey --secret /etc/openvpn/easy-rsa/pki/ta.key
      sudo ./easyrsa gen-cl
      ;;
   3) echo 'pattern 3'
      # exit 1
      # Get server sertificate
      sudo ./easyrsa build-server-full server nopass
 
      cd ./pki
      sudo cp ./pki/ca.crt /etc/openvpn/ca.crt
      sudo cp ./pki/dh.pem /etc/openvpn/dh.pem
      sudo cp ./pki/crl.pem /etc/openvpn/crl.pem
      sudo cp ./pki/ta.key /etc/openvpn/ta.key
      sudo cp ./pki/issued/server.crt /etc/openvpn/server.crt
      sudo cp ./pki/private/server.key /etc/openvpn/server.key
      ;;
   4) echo 'pattern 4'
      # exit 1
      # Server config-file
      sudo zcat /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz | sudo tee /etc/openvpn/server/server.conf
 
      echo "Your need editing server.config (/etc/openvpn/server/server.conf)!"
      echo -e "
      port 1194\n\
      proto udp\n\
      dev tun\n\
      ca ca.crt\n\
      cert server.crt\n\
      key server.key\n\
      dh dh.pem\n\
      server 10.8.0.0 255.255.255.0\n\
      ifconfig-pool-persist /var/log/openvpn/ipp.txt\n\
      push "dhcp-option DNS 8.8.8.8"\n\
      push "dhcp-option DNS 8.8.8.8"\n\
      keepalive 10 120\n\
      tls-auth ta.key 0\n\
      cipher AES-256-CBC\n\
      persist-key\n\
      persist-tun\n\
      status /var/log/openvpn/openvpn-status.log\n\
      verb 3\n\
      explocit-exit-notify 1\n\
      "
      ;;
 
   5) echo 'pattern 5'
      # exit 1
      # Start OpenVPN Server. After server.conf changes
      sudo openvpn /etc/openvpn/server/server.conf
      # Initialization Sequence Completed ???
      ;;
   6) echo 'pattern 6'
      # exit 1
      # Enable ip_forwarding
      sudo sysctl -w net.ipv4.ip_forward=1
      ;;
   7) echo 'pattern 7'
      # exit 1
      # Configuring the firewall
      sudo iptables -A INPUT -i enp1s3 -m state --state NEW -p udp --dport 1194 -j ACCEPT
      sudo iptables -A INPUT -i tun+ -j ACCEPT
      sudo iptables -A FORWARD -i tun+ -j ACCEPT
      sudo iptables -A FORWARD -i tun+ -o enp0s3 -m state --state RELATED,ESTABLISHED -j ACCEPT
      sudo iptables -A FORWARD -i enp0s3 -o tun+ -m state --state RELATED,ESTABLISHED -j ACCEPT
      sudo iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o enp0s3 -j MASQUERADE
      ;;
   *)
      echo 'Test!'
      ;;
esac
 
echo 'The end of fquest!'

