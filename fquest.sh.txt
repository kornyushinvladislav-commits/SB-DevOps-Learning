#! /bin/bash

echo "Hello, $USER!"

echo "S - server C - client"
read -p "Where will we work?  " where_wrk

#============================================================================================================
#if [ $where_wrk == "S" ]; then
#   echo "S will be selected"
#else
#   echo "C will be selected"
#fi

function testing_fnc ()
{
   exit 0
}
#testing_fnc "enp0s3"
#exit 1
#============================================================================================================

echo -e "1 - Install SertCenter\n2 - Customize Sert. Center\n3 - Get server sertif\n4 - Server config-file\n\
5 - Start OpenVPN Server\n6 - Enable ip_forwarding\n7 - Configuring the firewall\n* - Exit"
read -p "Enter a number: " number

# $1 - network interface
function ConfiguringFirewall ()
{
   # ip -br a / ip a
   #   1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000

   #      link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
   #      inet 127.0.0.1/8 scope host lo
   #         valid_lft forever preferred_lft forever
   #      inet6 ::1/128 scope host noprefixroute 
   #         valid_lft forever preferred_lft forever
   #   2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
   #      link/ether 08:00:27:e4:26:a3 brd ff:ff:ff:ff:ff:ff
   #      inet 192.168.0.109/24 brd 192.168.0.255 scope global dynamic noprefixroute enp0s3
   #         valid_lft 5933sec preferred_lft 5933sec
   #      inet6 fe80::a00:27ff:fee4:26a3/64 scope link 
   #         valid_lft forever preferred_lft forever

   # Configuring the firewall
   sudo iptables -A INPUT -i $1 -m state --state NEW -p udp --dport 1194 -j ACCEPT
   sudo iptables -A INPUT -i tun+ -j ACCEPT
   sudo iptables -A FORWARD -i tun+ -j ACCEPT
   sudo iptables -A FORWARD -i tun+ -o $1 -m state --state RELATED,ESTABLISHED -j ACCEPT
   sudo iptables -A FORWARD -i $1 -o tun+ -m state --state RELATED,ESTABLISHED -j ACCEPT
   sudo iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o $1 -j MASQUERADE
}

# Start OpenVPN Server service. After server.conf changes
# $1 - config-file name /etc/openvpn/server/server.conf or /etc/openvpn/server/client.conf
function StartOVPN ()
{
  sudo openvpn $1
  # Do you see "Initialization Sequence Completed" ?
}

function InstallOVPN ()
{
   # Install Sert. Center
   sudo apt-get update
   if [ $where_wrk == "S" && sudo apt-get install openvpn easy-rsa ]; then
      exit 0
   elif [ $where_wrk == "C" && sudo apt-get install openvpn ]; then
      exit 0
   else
      exit 33
   fi
}


case $number in
   1) echo 'pattern 1'
      exit 1

      # Install Sert. Center
      sudo apt-get update
      if [ $where_wrk == "S" ]; then
         sudo apt-get install openvpn easy-rsa
      elif [ $where_wrk == "C" ]
         sudo apt-get install openvpn
      else
         exit 33
      fi
      ;;
   2) echo 'pattern 2'
      exit 1
      # Customize Sert. Center
      if [ $where_wrk == "C" ]; then
         sudo mkdir /etc/openvpn/easy-rsa
         cd /etc/openvpn/easy-rsa/

         sudo ./easyrsa init-pki  # create pki-directory and required files
         sudo ./easyrsa build-ca  # create certification authority key
         sudo ./easyrsa gen-dh    # create Diffy-Hoffman key

         # create Hash-based Message Authentication Code (HMAC) key for TLS-authority
         sudo openvpn --genkey --secret /etc/openvpn/easy-rsa/pki/ta.key

         # create cancellation certificate
         sudo ./easyrsa gen-crl
      else
         echo "This is client execution! NOT A SERVER!"
         exit 30
      fi
      ;;
   3) echo 'pattern 3'
      exit 1
      if [ $where_wrk == "C" ]; then
         cd /etc/openvpn/easy-rsa/

         # Get server sertificate
         sudo ./easyrsa build-server-full server nopass

         # cd ./pki
         # copy certificates to server directory
         sudo cp ./pki/ca.crt /etc/openvpn/server/ca.crt
         sudo cp ./pki/dh.pem /etc/openvpn/server/dh.pem
         sudo cp ./pki/crl.pem /etc/openvpn/server/crl.pem
         sudo cp ./pki/ta.key /etc/openvpn/server/ta.key
         sudo cp ./pki/issued/server.crt /etc/openvpn/server/server.crt
         sudo cp ./pki/private/server.key /etc/openvpn/server/server.key
      else
         echo "This is client execution! NOT A SERVER!"
         exit 30
      fi
      ;;
   4) echo 'pattern 4'
      exit 1
      if [ $where_wrk == "S" ]; then
         # Get server config-file
         sudo zcat /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz | sudo tee /etc/openvpn/server/server.conf
         echo "Your need editing server.config (/etc/openvpn/server/server.conf)!"
         echo -e "
         port 1194\n\
         proto udp\n\
         dev tun\n\
         ca ca.crt\n\
         cert server.crt\n\
         key server.key\n\
         dh dh.pem\n\
         server 10.8.0.0 255.255.255.0\n\
         ifconfig-pool-persist /var/log/openvpn/ipp.txt\n\
         push "dhcp-option DNS 8.8.8.8"\n\
         push "dhcp-option DNS 8.8.8.8"\n\
         keepalive 10 120\n\
         tls-auth ta.key 0\n\
         cipher AES-256-CBC\n\
         persist-key\n\
         persist-tun\n\
         status /var/log/openvpn/openvpn-status.log\n\

         verb 3\n\
         explocit-exit-notify 1\n\
         "
      else
         echo "This is server execution! NOT CLIENT!"
         exit 30
      fi
      ;;
   5) echo 'pattern 5'
      exit 1
      if [ $where_wrk == "S" ]; then
         StartOVPN /etc/openvpn/server/server.conf  # Start OpenVPN Server service. After server.conf changes
                                                    # Do you see "Initialization Sequence Completed" ?
      else
         echo "This is server execution! NOT CLIENT!"
         exit 30
      fi
      ;;
   6) echo 'pattern 6'
      exit 1
      # Enable ip_forwarding
      sudo sysctl -w net.ipv4.ip_forward=1
      ;;
   7) echo 'pattern 7'
      exit 1
      ConfiguringFirewall enp0s3
      ;;
   *)
      echo 'Test!'
      ;;
esac

echo 'The end of fquest!'
